# Agent Instruction Sheet: Build StackedDiffFS (StackedFS) v1 Prototype

**Objective:**

Build a minimal prototype of **StackedDiffFS (StackedFS)**, a horizontal, merge-safe filesystem for AI agents that works on Linux and macOS. The FS should mediate reads and writes for multiple agents without requiring changes to the agents themselves.

---

## 1. Goals

1. Transparent filesystem overlay for existing tools (editors, compilers, git, containers).
2. Enforce **write safety**: conflicting writes are rejected or isolated.
3. Maintain **per-agent diff directories** stacked on top of a read-only base.
4. Integrate with `direnv` for automatic environment setup.
5. Compatible with Linux (FUSE) and macOS (macFUSE).

---

## 2. Constraints

* Prototype is **local only**; no networked FS.
* No auto-merging; conflicts are **write rejection only**.
* FS should handle typical source-tree workloads (text files, small binaries).
* Must support containers via volume mounts.
* Minimal CLI: `mount`, `unmount`, `status`, `agent add`.

---

## 3. Architecture

```
Host FS
└── repo/
      ├── base/           (read-only)
      ├── agent-a/        (writeable diff)
      ├── agent-b/        (writeable diff)
      └── work/           (FUSE mount exposed to agents)
```

* **Read resolution:** topmost agent layer → fallback layers → base
* **Write handling:**

  * Check for conflicts based on current file hash
  * Reject writes if base or upper layers changed
  * Otherwise, write to agent-specific diff layer
* **Conflict logging:** accessible via CLI (`stackedfs status`, `stackedfs conflicts`)

---

## 4. CLI Requirements

```bash
# Initialize repo
stackedfs init ./repo

# Mount FS
stackedfs mount ./repo ./repo.stackedfs

# Add agent
stackedfs agent add claude

# Show status and conflicts
stackedfs status
stackedfs conflicts

# Unmount FS
stackedfs unmount ./repo.stackedfs

# Optional: integrate with direnv for automatic environment setup
stackedfs direnv
```

* `direnv` should set `$STACKEDFS_WORKDIR` and `$AGENT_ID` automatically.
* Containers mount `$STACKEDFS_WORKDIR` as `/workspace`.

---

## 5. FUSE Operations to Implement

**Minimum viable FUSE handlers:**

* `lookup` / `getattr` → resolve topmost layer
* `readdir` → merge directory entries across layers
* `open` → allow reads from resolved layer
* `read` → topmost layer → fallback
* `write` → enforce conflict detection, copy-on-write per agent
* `create` → place in agent layer
* `unlink` → agent-only deletion
* `rename` → check for conflicts
* `flush` / `fsync` → optional

*Note:* Internal diff directories handle copy-on-write semantics.

---

## 6. StackedFS + direnv Integration

* `.envrc` is generated by `stackedfs direnv` command:

```bash
export STACKEDFS_WORKDIR=./repo.stackedfs/work
export AGENT_ID=claude
```

* Users run `direnv allow` to activate.
* Any process in the shell sees `$AGENTFS_WORKDIR` as the workspace.

---

## 7. Success Criteria

* Existing tools (editors, compilers, git) operate normally inside `work/`.
* Conflicting writes are **rejected or isolated** per-agent.
* Multiple agents can operate concurrently without overwriting each other.
* Prototype runs on **Linux (FUSE)** and **macOS (macFUSE)**.
* Containers can mount the FS and use it transparently.

---

## 8. Suggested Development Steps

1. Implement minimal FUSE overlay: reads + writes, per-agent diff, conflict rejection.
2. CLI commands: `mount`, `unmount`, `status`, `agent add`.
3. Direnv integration for automatic environment activation.
4. Test with:

   * a small repo (~50 files)
   * multiple dummy agents writing concurrently
   * git operations inside FS
   * container mount with agents inside `/workspace`

